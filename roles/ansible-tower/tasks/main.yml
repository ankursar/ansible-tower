- name: check packages for updates
  shell: yum list updates | awk 'f;/Updated Packages/{f=1;}' | awk '{ print $1 }'
  changed_when: updates.stdout_lines | length > 0
  args:
    warn: false
  register: updates

- name: display count
  debug:
    msg: "Found {{ updates.stdout_lines | length }} packages to be updated:\n\n{{ updates.stdout }}"

- when: updates.stdout_lines | length > 0
  block:
    - name: install updates using yum
      yum:
        name: "*"
        state: latest

    - name: 1. Install Ansible and yum-utils Packages
      yum: name={{ item }} state=present
      with_items:
          - yum-utils
          - ansible

    - name: check if reboot is required
      shell: needs-restarting -r
      failed_when: false
      register: reboot_required
      changed_when: false

- when: updates.stdout_lines | length > 0 and reboot_required.rc != 0
  block:
    - name: reboot the server if required
      shell: sleep 3; reboot
      ignore_errors: true
      changed_when: false
      async: 1
      poll: 0

    - name: wait for server to come back after reboot
      wait_for_connection:
        timeout: 600
        delay: 20
      register: reboot_result

    - name: reboot time
      debug:
        msg: "The system rebooted in {{ reboot_result.elapsed }} seconds."
                
- name: Creates "/temp/tower" directory
  file:
    path: /tmp/tower
    state: directory

- name: Download and extract the latest releases of Ansible Tower
  unarchive:
    src: https://releases.ansible.com/ansible-tower/setup/ansible-tower-setup-latest.tar.gz
    dest: /tmp/tower
    remote_src: yes
                
- name: Updated the Inventory file for Ansible Tower Installation
  copy: src=inventory dest=/tmp/tower/ansible-tower-setup-3.8.0-1/inventory mode=0777

- name: Ansible Tower Installation begin
  command: sh /tmp/tower/ansible-tower-setup-3.8.0-1/setup.sh
